name: publish_conda

on:
   push
jobs:
  build:
    strategy:
      matrix:
        python: ['3.9']
        os: ['windows-2016','ubuntu-latest']
    runs-on: ${{ matrix.os }}     
    steps:
    - uses: actions/checkout@v2
    - name: submodules
#       shell: bash -l {0}
      run: |
        git submodule update --init --recursive
    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        python-version: ${{ matrix.python }} 
        activate-environment: loop    
    - name: Conda build
#       shell: powershell
      run: |
        conda install -c conda-forge conda-build scikit-build numpy=1.20 cython
        conda build -c anaconda -c conda-forge -c loop3d --output-folder conda conda
    - name: upload
      env:
        ANACONDA_API_TOKEN: ${{ secrets.ANACONDA }}
      run: | 
        conda install anaconda-client
        anaconda -v -t ${{ secrets.ANACONDA }} upload --label main conda/win-64/*.tar.bz2 --force
#   upload:
#       needs: windows
#       runs-on: ubuntu-latest
#       steps:
#       - name: Download artifacts
#         uses: actions/download-artifact@v2
#         with:
#           name: windows
#       - name: install anaconda
#         uses: conda-incubator/setup-miniconda@v2
#         with:
#            python-version: 3.8
#            activate-environment: loop
#       - name: upload
#         run: |
#          conda install -y anaconda-client
#          anaconda upload windows/*
        
